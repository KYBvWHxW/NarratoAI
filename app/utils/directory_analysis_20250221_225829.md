我来详细分析这段代码:

### 1. 功能概述

**主要目标:**
- 提供一个通用的AI文本生成框架，支持OpenAI等多种AI模型
- 专门用于生成视频/场景脚本内容

**解决的问题:**
- 实现基于场景的连续性文案生成
- 处理文本长度控制和上下文衔接
- 提供统一的错误处理和重试机制

**输入输出:**
- 输入: 场景描述、字数要求、提示词(prompt)
- 输出: 生成的脚本文本

### 2. 架构设计

**整体架构:**
- 采用基类+具体实现类的架构模式
- BaseGenerator: 抽象基类,定义通用接口
- OpenAIGenerator: OpenAI具体实现

**核心类职责:**
- BaseGenerator: 提供基础生成框架和通用功能
- OpenAIGenerator: 实现OpenAI API特定的生成逻辑

**设计模式:**
- 模板方法模式: 基类定义框架,子类实现具体细节
- 策略模式: 支持不同AI模型的实现切换

### 3. 实现细节

**主要函数:**
- generate_script(): 脚本生成的主要入口
- _try_generate(): 实现重试机制
- _generate(): 具体生成逻辑(需子类实现)

**关键算法:**
- 文本分块和衔接处理
- Token计数和长度控制
- 重试和错误容错机制

**异常处理:**
- 多层异常捕获和日志记录
- 重试机制处理临时错误

### 4. 依赖分析

**外部依赖:**
- openai: OpenAI API客户端
- tiktoken: Token计数工具
- loguru: 日志处理
- google.generativeai: Google AI接口(预留)

### 5. 核心流程

**生成流程:**
1. 初始化生成器配置
2. 组装提示词和上下文
3. 调用AI模型生成内容
4. 处理响应并更新上下文
5. 错误处理和重试

**数据流:**
1. 输入场景描述转换为提示词
2. 提示词经AI处理生成文本
3. 文本经过后处理和验证
4. 更新历史记录和上下文

这是一个结构良好、可扩展的AI文本生成框架,具有较完善的错误处理和可维护性。